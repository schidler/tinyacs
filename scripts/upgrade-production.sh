#!/bin/bash

######################################################################
###### Determine SXA-CC Home Path
######################################################################
SCRIPT_DIR=`dirname $0`
SCRIPT_DIR=$(cd $SCRIPT_DIR; pwd)
SXACC_HOME=`cd $SCRIPT_DIR/..; pwd`

#########################################################################
###### Save the current running version
#########################################################################
CURRENT_VERSION=`cat $SXACC_HOME/conf/version.txt`
echo "#########################################################################"
echo "Current running version is $CURRENT_VERSION."
echo "#########################################################################"

#########################################################################
###### Check the latest version
#########################################################################
echo "#########################################################################"
echo "Checking the latest build version for production release..."
echo "#########################################################################"
$SCRIPT_DIR/server.sh check-version production
NEW_VERSION=`cat $SXACC_HOME/conf/version.txt`
echo "#########################################################################"
echo "Latest build version is $NEW_VERSION."
echo "#########################################################################"

if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
    echo "#########################################################################"
    echo "Already running the latest build."
    echo "#########################################################################"
    exit 1
fi

#########################################################################
###### Restore the old version to stop the running process
#########################################################################
rm $SXACC_HOME/conf/version.txt
echo $NEW_VERSION > $SXACC_HOME/conf/version.txt
echo "#########################################################################"
echo "Stopping the running processes..."
echo "#########################################################################"
$SCRIPT_DIR/server.sh stop acs
$SCRIPT_DIR/server.sh stop cpe

#########################################################################
###### Update the version file with the new version string
#########################################################################
echo $CURRENT_VERSION > $SXACC_HOME/conf/version.txt

#########################################################################
###### Fetch the new artifacts
#########################################################################
echo "#########################################################################"
echo "Fetching the new artifacts..."
echo "#########################################################################"
$SCRIPT_DIR/server.sh fetch acs
$SCRIPT_DIR/server.sh fetch cpe

#########################################################################
###### Start the processes with the new artifacts
#########################################################################
echo "#########################################################################"
echo "Starting the server processes with the new artifacts..."
echo "#########################################################################"
$SCRIPT_DIR/server.sh start acs
$SCRIPT_DIR/server.sh start cpe
echo "#########################################################################"
ehco "All done."
echo "#########################################################################"
